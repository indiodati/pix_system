<% withdrawal ||= @withdrawal %>

<%= form_with model: withdrawal,
              url: withdrawals_path,
              local: true do |form| %>


  <!-- Valor -->
  <div class="mb-4">
    <%= form.label :amount, "Valor do saque (R$)", class: "block font-medium mb-1" %>
    <%= form.text_field :amount,
                        class: "money-input w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-400",
                        placeholder: "Ex: 500,00" %>
    <p class="text-xs text-gray-500 mt-1">
      Você pode sacar no máximo
      <strong><%= number_to_currency(@max_withdrawable_reais, unit: "R$") %></strong> agora.
    </p>
  </div>

  <!-- Tipo da chave -->
  <div class="mb-4">
    <%= label_tag :pix_key_type, "Tipo da chave PIX", class: "block font-medium mb-1" %>
    <%= select_tag "withdrawal[pix_key_type]",
                   options_for_select(
                     [
                       ["CPF", "CPF"],
                       ["CNPJ", "CNPJ"],
                       ["E-mail", "EMAIL"],
                       ["Telefone", "PHONE"],
                       ["Chave Aleatória (EVP)", "EVP"]
                     ],
                     params.dig(:withdrawal, :pix_key_type).presence || "CPF"
                   ),
                   id: "withdrawal_pix_key_type",
                   class: "w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-400" %>
  </div>

  <!-- Chave PIX -->
  <div class="mb-4">
    <%= form.label :pix_key, "Chave PIX para receber", class: "block font-medium mb-1" %>
    <%= form.text_field :pix_key,
                        placeholder: "CPF, CNPJ, e-mail, telefone ou chave aleatória",
                        class: "w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-400" %>
  </div>

  <div class="mt-6">
    <%= form.submit "Solicitar Saque",
                    class: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200" %>
    <%= link_to "Voltar", withdrawals_path,
                class: "ml-2 text-gray-600 hover:text-gray-800 hover:underline" %>
  </div>
<% end %>

<!-- === MÁSCARAS E VALIDAÇÕES DE CHAVE PIX === -->
<script>
  (function() {
    // === MÁSCARA DE DINHEIRO ===
    function attachMoneyMask() {
      var inputs = document.querySelectorAll('.money-input');
      if (!inputs.length) return;

      inputs.forEach(function(input) {
        input.addEventListener('input', function(e) {
          var value = e.target.value.replace(/\D/g, '');
          if (value === '') {
            e.target.value = '';
            return;
          }
          var cents = parseInt(value, 10);
          var reais = cents / 100;
          e.target.value = reais.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        });

        if (input.value && input.value.match(/\d/)) {
          var evt = new Event('input', { bubbles: true });
          input.dispatchEvent(evt);
        }
      });
    }

    // === FUNÇÕES DE VALIDAÇÃO ===
    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]/g, '');
      if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;

      let soma = 0;
      for (let i = 0; i < 9; i++) soma += parseInt(cpf[i]) * (10 - i);
      let resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf[9])) return false;

      soma = 0;
      for (let i = 0; i < 10; i++) soma += parseInt(cpf[i]) * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;

      return resto === parseInt(cpf[10]);
    }

    function validarCNPJ(cnpj) {
      cnpj = cnpj.replace(/[^\d]/g, '');
      if (cnpj.length !== 14 || /^(\d)\1{13}$/.test(cnpj)) return false;

      let tamanho = cnpj.length - 2;
      let numeros = cnpj.substring(0, tamanho);
      let digitos = cnpj.substring(tamanho);
      let soma = 0;
      let pos = tamanho - 7;

      for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
      }
      let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
      if (resultado != digitos.charAt(0)) return false;

      tamanho = tamanho + 1;
      numeros = cnpj.substring(0, tamanho);
      soma = 0;
      pos = tamanho - 7;
      for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
      }
      resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
      return resultado == digitos.charAt(1);
    }

    // === MÁSCARAS DE FORMATAÇÃO ===
    function formatCPF(value) {
      return value
        .replace(/\D/g, '')
        .slice(0, 11)
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }

    function formatCNPJ(value) {
      return value
        .replace(/\D/g, '')
        .slice(0, 14)
        .replace(/^(\d{2})(\d)/, '$1.$2')
        .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
        .replace(/\.(\d{3})(\d)/, '.$1/$2')
        .replace(/(\d{4})(\d)/, '$1-$2');
    }

    function formatPhone(value) {
      return value
        .replace(/\D/g, '')
        .slice(0, 11)
        .replace(/^(\d{2})(\d)/, '($1) $2')
        .replace(/(\d{5})(\d)/, '$1-$2');
    }

    function attachPixKeyMask() {
      const input  = document.querySelector('input[name="withdrawal[pix_key]"]');
      const select = document.querySelector('#withdrawal_pix_key_type');
      if (!input || !select) return;

      let msg = document.createElement('p');
      msg.className = 'text-xs mt-1 text-red-500 hidden';
      input.insertAdjacentElement('afterend', msg);

      function showError(text) {
        msg.textContent = text;
        msg.classList.remove('hidden');
        input.classList.add('border-red-500', 'focus:ring-red-400');
      }

      function clearError() {
        msg.classList.add('hidden');
        input.classList.remove('border-red-500', 'focus:ring-red-400');
      }

      function applyMaskAndValidate() {
        const type = select.value;
        let value  = input.value;

        clearError();

        switch (type) {
          case 'CPF':
            input.value = formatCPF(value);
            input.placeholder = '000.000.000-00';
            if (value.replace(/[^\d]/g, '').length === 11 && !validarCPF(value)) {
              showError('CPF inválido');
            }
            break;
          case 'CNPJ':
            input.value = formatCNPJ(value);
            input.placeholder = '00.000.000/0000-00';
            if (value.replace(/[^\d]/g, '').length === 14 && !validarCNPJ(value)) {
              showError('CNPJ inválido');
            }
            break;
          case 'PHONE':
            input.value = formatPhone(value);
            input.placeholder = '(00) 00000-0000';
            break;
          case 'EMAIL':
            input.value = value.trim();
            input.placeholder = 'exemplo@email.com';
            if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
              showError('E-mail inválido');
            }
            break;
          case 'EVP':
            input.value = value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
            input.placeholder = 'Chave aleatória (UUID)';
            break;
        }
      }

      input.addEventListener('input', applyMaskAndValidate);
      select.addEventListener('change', function() {
        input.value = '';
        clearError();
        applyMaskAndValidate();
      });

      applyMaskAndValidate();
    }

    function init() {
      attachMoneyMask();
      attachPixKeyMask();
    }

    document.addEventListener('DOMContentLoaded', init);
    document.addEventListener('turbo:load', init);
  })();
</script>
