<h1 class="text-3xl font-bold mb-6">Clientes</h1>

<!-- =======================
     CARDS DE MÉTRICAS
     ======================= -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <!-- Saldo total em carteira -->
  <div class="bg-white shadow rounded p-4">
    <p class="text-xs font-semibold text-gray-500 uppercase">Saldo total em carteira</p>
    <p class="mt-2 text-2xl font-bold text-gray-800">
      <%= number_to_currency(@total_balance_reais, unit: "R$", separator: ",", delimiter: ".") %>
    </p>
    <p class="mt-1 text-xs text-gray-500">
      Soma dos saldos de todos os clientes.
    </p>
  </div>

  <!-- Volume total PIX pago -->
  <div class="bg-white shadow rounded p-4">
    <p class="text-xs font-semibold text-gray-500 uppercase">Volume total PIX (paid)</p>
    <p class="mt-2 text-2xl font-bold text-gray-800">
      <%= number_to_currency(@total_pix_volume_reais, unit: "R$", separator: ",", delimiter: ".") %>
    </p>
    <p class="mt-1 text-xs text-gray-500">
      Somente transações PIX com status "paid".
    </p>
  </div>

  <!-- Ganhos em taxas -->
  <div class="bg-white shadow rounded p-4">
    <p class="text-xs font-semibold text-gray-500 uppercase">Ganhos em taxas PIX</p>
    <p class="mt-2 text-2xl font-bold text-emerald-600">
      <%= number_to_currency(@total_fees_earned_reais, unit: "R$", separator: ",", delimiter: ".") %>
    </p>
    <p class="mt-1 text-xs text-gray-500">
      Soma de todas as <code>fee_amount</code> das transações "paid".
    </p>
  </div>
</div>

<!-- =======================
     CABEÇALHO + BOTÃO
     ======================= -->
<div class="mb-4 flex justify-between items-center">
  <p class="text-gray-600 text-sm">
    Gerencie os clientes, seus saldos e taxas de PIX.
  </p>
  <%= link_to "Novo Cliente",
              new_admin_user_path,
              class: "bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2 px-4 rounded" %>
</div>

<!-- =======================
     GRÁFICO PIX (30 DIAS)
     ======================= -->
<div class="bg-white shadow rounded mb-6 border border-gray-200">
  <div class="px-4 py-3 border-b border-gray-200">
    <h2 class="text-sm font-semibold text-gray-700">
      Volume PIX (últimos 30 dias)
    </h2>
    <p class="text-xs text-gray-500">
      Linha sólida: volume total. Linha tracejada: taxas arrecadadas.
    </p>
  </div>
  <div class="p-4">
    <canvas id="pixChart" height="80"></canvas>
  </div>
</div>

<!-- =======================
     ÚLTIMAS 10 TRANSAÇÕES PIX (DIVs)
     ======================= -->
<div class="bg-white shadow rounded mb-8 border border-gray-200">
  <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
    <h2 class="text-sm font-semibold text-gray-700">
      Últimas 10 transações PIX
    </h2>
    <%= link_to "Ver todas", pix_transactions_path,
                class: "text-xs text-blue-600 hover:text-blue-800 underline" %>
  </div>

  <% if @recent_pix_transactions.any? %>
    <!-- Cabeçalho (desktop) -->
    <div class="hidden md:grid grid-cols-7 gap-4 px-4 py-2 bg-gray-50 border-b border-gray-200 text-xs font-medium text-gray-500 uppercase tracking-wider">
      <div>Data</div>
      <div>Cliente</div>
      <div>Gateway</div>
      <div class="text-right">Valor</div>
      <div class="text-right">Taxa</div>
      <div class="text-right">Líquido</div>
      <div class="text-center">Status</div>
    </div>

    <!-- Linhas -->
    <div class="divide-y divide-gray-100">
      <% @recent_pix_transactions.each do |tx| %>
        <% valor_reais   = tx.amount.to_i / 100.0 %>
        <% taxa_reais    = tx.fee_amount.to_i / 100.0 %>
        <% liquido_reais = tx.net_amount_cents.to_i / 100.0 %>
        <% u = tx.user %>
        <% status = tx.status.to_s.downcase %>
        <% badge_classes =
             case status
             when "paid"
               "bg-green-100 text-green-800"
             when "pending"
               "bg-yellow-100 text-yellow-800"
             when "failed", "canceled"
               "bg-red-100 text-red-800"
             else
               "bg-gray-100 text-gray-700"
             end %>

        <div class="px-4 py-3 hover:bg-gray-50 transition flex flex-col md:grid md:grid-cols-7 md:gap-4">
          <!-- Data -->
          <div class="md:col-span-1 text-sm text-gray-700">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Data</div>
            <div><%= l tx.created_at, format: :short %></div>
          </div>

          <!-- Cliente -->
          <div class="md:col-span-1 text-sm text-gray-700">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Cliente</div>
            <div class="flex flex-col">
              <span><%= u&.name.presence || "-" %></span>
              <span class="text-xs text-gray-500"><%= u&.email %></span>
            </div>
          </div>

          <!-- Gateway -->
          <div class="md:col-span-1 text-sm text-gray-700">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Gateway</div>
            <% if tx.witetec? %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                Witetec
              </span>
            <% elsif tx.santsbank? %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                SantsBank
              </span>
            <% else %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
                -
              </span>
            <% end %>
          </div>

          <!-- Valor -->
          <div class="md:col-span-1 text-sm text-gray-700 md:text-right">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Valor</div>
            <div>
              <%= number_to_currency(valor_reais, unit: "R$", separator: ",", delimiter: ".") %>
            </div>
          </div>

          <!-- Taxa -->
          <div class="md:col-span-1 text-sm text-gray-700 md:text-right">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Taxa</div>
            <div>
              <%= number_to_currency(taxa_reais, unit: "R$", separator: ",", delimiter: ".") %>
            </div>
          </div>

          <!-- Líquido -->
          <div class="md:col-span-1 text-sm text-gray-700 md:text-right">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Líquido</div>
            <div>
              <%= number_to_currency(liquido_reais, unit: "R$", separator: ",", delimiter: ".") %>
            </div>
          </div>

          <!-- Status -->
          <div class="md:col-span-1 text-sm md:text-center mt-2 md:mt-0">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Status</div>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium <%= badge_classes %>">
              <%= status.upcase %>
            </span>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="px-4 py-4 text-sm text-gray-500">
      Nenhuma transação PIX encontrada.
    </p>
  <% end %>
</div>

<!-- =======================
     LISTA DE CLIENTES (DIVs)
     ======================= -->
<div class="bg-white shadow rounded border border-gray-200 mb-8">
  <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
    <h2 class="text-sm font-semibold text-gray-700">
      Lista de clientes
    </h2>
  </div>

  <% if @users.any? %>
    <!-- Cabeçalho (desktop) -->
    <div class="hidden md:grid grid-cols-8 gap-4 px-4 py-2 bg-gray-50 border-b border-gray-200 text-xs font-medium text-gray-500 uppercase tracking-wider">
      <div>ID</div>
      <div>Nome</div>
      <div>E-mail</div>
      <div>Telefone</div>
      <div>Saldo</div>
      <div>Taxa PIX (%)</div>
      <div>Admin</div>
      <div class="text-right">Ações</div>
    </div>

    <!-- Linhas -->
    <div class="divide-y divide-gray-100">
      <% @users.each do |user| %>
        <% saldo = user.balance_cents.to_f / 100 %>

        <div class="px-4 py-3 hover:bg-gray-50 transition flex flex-col md:grid md:grid-cols-8 md:gap-4">
          <!-- ID -->
          <div class="md:col-span-1 text-sm text-gray-700">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">ID</div>
            <div><%= user.id %></div>
          </div>

          <!-- Nome -->
          <div class="md:col-span-1 text-sm text-gray-700">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Nome</div>
            <div><%= user.name.presence || "-" %></div>
          </div>

          <!-- E-mail -->
          <div class="md:col-span-1 text-sm text-gray-700">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">E-mail</div>
            <div><%= user.email %></div>
          </div>

          <!-- Telefone -->
          <div class="md:col-span-1 text-sm text-gray-700">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Telefone</div>
            <div><%= user.phone.presence || "-" %></div>
          </div>

          <!-- Saldo -->
          <div class="md:col-span-1 text-sm text-gray-700">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Saldo</div>
            <div>
              <% if saldo > 0 %>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                  <%= number_to_currency(saldo, unit: "R$", separator: ",", delimiter: ".") %>
                </span>
              <% elsif saldo == 0 %>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600">
                  R$0,00
                </span>
              <% else %>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">
                  <%= number_to_currency(saldo, unit: "R$", separator: ",", delimiter: ".") %>
                </span>
              <% end %>
            </div>
          </div>

          <!-- Taxa PIX -->
          <div class="md:col-span-1 text-sm text-gray-700">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Taxa PIX (%)</div>
            <div>
              <%= number_with_precision(user.pix_fee_percent || 0, precision: 2) %>%
            </div>
          </div>

          <!-- Admin -->
          <div class="md:col-span-1 text-sm text-gray-700">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5">Admin</div>
            <% if user.admin? %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                Administrador
              </span>
            <% else %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                Usuário
              </span>
            <% end %>
          </div>

          <!-- Ações -->
          <div class="md:col-span-1 text-sm text-right mt-3 md:mt-0">
            <div class="md:hidden text-[11px] uppercase text-gray-400 mb-0.5 text-left">Ações</div>
            <div class="flex md:justify-end gap-2">
              <%= link_to "Editar",
                          edit_admin_user_path(user),
                          class: "bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold py-1 px-3 rounded" %>

              <% unless user == current_user %>
                <%= button_to "Excluir",
                              admin_user_path(user),
                              method: :delete,
                              data: { confirm: "Tem certeza que deseja excluir este usuário?" },
                              class: "bg-red-600 hover:bg-red-700 text-white text-xs font-semibold py-1 px-3 rounded" %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="px-4 py-4 text-sm text-gray-500">
      Nenhum usuário encontrado.
    </p>
  <% end %>
</div>

<!-- =======================
     SCRIPTS DO GRÁFICO
     ======================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var canvas = document.getElementById("pixChart");
    if (!canvas) return;

    var labels = <%= raw @pix_chart_labels.to_json %>;
    var volume = <%= raw @pix_chart_values.to_json %>;
    var fees   = <%= raw @pix_chart_fees.to_json %>;

    var ctx = canvas.getContext("2d");

    new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          {
            label: "Volume PIX (R$)",
            data: volume,
            borderWidth: 2,
            tension: 0.3,
            fill: false
          },
          {
            label: "Taxas (R$)",
            data: fees,
            borderWidth: 2,
            borderDash: [5, 4],
            tension: 0.3,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: "index",
          intersect: false
        },
        plugins: {
          legend: {
            position: "bottom"
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                var v = context.parsed.y || 0;
                return context.dataset.label + ": R$ " +
                  v.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
              }
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: function(value) {
                return "R$ " + value.toLocaleString("pt-BR", {
                  minimumFractionDigits: 2
                });
              }
            }
          }
        }
      }
    });
  });
</script>
